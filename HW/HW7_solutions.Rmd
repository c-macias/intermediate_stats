---
title: "HW7 - Categorical and Count data"
author: "Frank Edwards"
date: "4/8/2019"
output: html_document
---

```{r echo = FALSE, message = FALSE}
library(tidyverse)
fe<-read_csv("./data/fe_division_rural.csv")
```

DUE 5/26, 10AM

This assignment uses aggregated data from Fatal Encounters.

This data contains the following measures:

- fips: a 5-digit FIPS county code
- state: a two-letter state abbreviation
- ur.code: a six category urban-rural classification from the CDC
- division: a nine category Census regional division classificaiton
- black.men, white.men, latino.men: adult male population by race/ethnicity
- tot.men: total adult male population
- d.asian, d.black, d.latino, d.other, d.white, d.na, d.total: men killed by police by race/ethnicity

## Section 1: Categorical models

1. Explore the distribution of adult male population across county metro types (ur.code).

```{r}
ggplot(fe, 
       aes(x = tot.men)) + 
  geom_histogram() + 
  facet_wrap(~ur.code, scales = "free")
```

2. Explore how this distribution varies by census division

```{r}
ggplot(fe, 
       aes(x = tot.men)) + 
  geom_histogram() + 
  scale_x_log10() + 
  facet_wrap(~division, scales = "free")
```

3. Estimate a multinomial regression model with ur.code as the outcome. See if you can predict a county's metropolitan type based on variables in the dataset. Explain your modeling choices.

```{r}
library(nnet)

m1<-multinom(ur.code ~ log(tot.men),
             data = fe)

m2<-multinom(ur.code ~ log(tot.men) + division,
             data = fe)

fake_data<-data.frame(tot.men = seq(from = 1, to = 1e6, by = 10))

preds<-as.data.frame(predict(m1, fake_data, "probs"))

preds<-preds%>%
  gather(key = ur.code, value = probs)

preds<-preds%>%
  bind_cols(tot.men = rep(fake_data$tot.men, 6))

ggplot(preds,
       aes(x = tot.men, y = probs,
           color = ur.code)) +
  geom_line()
```

4. Interpret your model.

Population is a great predictor of county metro type. The model has a hard time distinguishing between medium metros and large fringe metros, but otherwise, appears to make clear classifications based on population size alone. Adding division doesn't help much. Maybe adding ethnic population composition would help.

## Section 2: Count models

Use the data frame fe_long, created from included code in the .Rmd file that reshapes the data from wide to long. 

```{r echo = FALSE, message = FALSE}
#First, transform the data using this code
fe_long_pop<-fe%>%
  select(fips, state, ur.code, division, black.men, white.men, latino.men)%>%
  rename(black = black.men, white = white.men, latino = latino.men)%>%
  gather(key = "race", value = "pop", -fips, -state, -ur.code, -division)

fe_long<-fe%>%
  select(fips, state, ur.code, division, d.black, d.latino, d.white)%>%
  rename(black = d.black, latino = d.latino, white = d.white)%>%
  gather(key = "race", value = "deaths", -fips, -state, -ur.code, -division)%>%
  left_join(fe_long_pop)
```

1. Explore counts of death by division

```{r}
fe_long_total<-fe_long%>%
  group_by(division)%>%
  summarise(deaths = sum(deaths),
            death.rt = sum(deaths) / sum(pop) * 1e5)

fe_long_total
```


2. Explore counts of death by ur.code

```{r}
fe_long_total<-fe_long%>%
  group_by(ur.code)%>%
  summarise(deaths = sum(deaths),
            death.rt = sum(deaths) / sum(pop) * 1e5)

fe_long_total
```

3. Explore counts of death by race

```{r}
fe_long_total<-fe_long%>%
  group_by(race)%>%
  summarise(deaths = sum(deaths),
            death.rt = sum(deaths) / sum(pop) * 1e5)

fe_long_total
```

4. Include at least one additional data visual that you find informative.

```{r}
fe_long_total<-fe_long%>%
  group_by(race, ur.code, division)%>%
  summarise(deaths = sum(deaths),
            death.rt = sum(deaths) / sum(pop) * 1e5)

ggplot(fe_long_total, aes(x = deaths, y = ur.code, color = race, group = race)) + 
  geom_point() + 
  facet_wrap(~division)
```

5. Provide an analysis of whether race/ethnicity correlates with rates at which men are killed by police. Include any regression predictors you find appropriate. Use any model you find appropriate. Explain your choices clearly and interpret your results.

```{r}
m1<-glm(deaths ~ race + 
          offset(I(log(pop+1))), 
                               data = fe_long)

m2<-glm(deaths ~ race + ur.code + 
          offset(I(log(pop+1))), 
                               data = fe_long)

m3<-glm(deaths ~ race + ur.code + division + 
          offset(I(log(pop+1))), 
                               data = fe_long)

m4<-glm(deaths ~ race * (ur.code + division) + 
          offset(I(log(pop+1))), 
                               data = fe_long)

BIC(m1);BIC(m2);BIC(m3);BIC(m4)

library(broom)
m1_t<-tidy(m1)
#black risk
exp(m1_t$estimate[1]) * 1e5
#latino risk
exp(m1_t$estimate[1] + m1_t$estimate[2]) * 1e5
#white risk
exp(m1_t$estimate[1] + m1_t$estimate[3]) * 1e5

```

