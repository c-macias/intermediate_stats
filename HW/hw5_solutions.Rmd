---
title: "HW5 Solutions"
author: "Frank Edwards"
date: "3/8/2019"
output: html_document
---

```{r setup, echo = FALSE, message = FALSE}
library(tidyverse)
library(broom)
library(xtable)
set.seed(1)

options(xtable.comment = FALSE)
theme_set(theme_minimal())

titanic<-read_csv("./data/titanic.csv")
```

### Exploratory data analysis

```{r}
titanic<-titanic%>%
  mutate(Pclass = as.character(Pclass))%>%
  rename(sibs = `Siblings/Spouses Aboard`, kids = `Parents/Children Aboard`)

## Summarize survival
mean(titanic$Survived)

## survival rates by class, sex, age
## can use xtable() to make these pretty
titanic%>%
  group_by(Pclass)%>%
  summarise(p_surv = mean(Survived))

titanic%>%
  group_by(Sex)%>%
  summarise(p_surv = mean(Survived))

titanic%>%
  group_by(Age<18)%>%
  summarise(p_surv = mean(Survived))
```

### A simple model

```{r}
m1<-glm(Survived~
          Age,
        data = titanic)
m1_results<-tidy(m1)
m1_results$odds_ratio<-exp(m1_results$estimate)
m1_results
```

#### Look at model performance - crude check

```{r}
### make a check results function
check_logit_results<-function(m){
  ### generate predicted probabilities for observed data
  yhat<-predict(m, type = "response")
  ### make a df with yhat and observed to check performance
  check<-bind_cols(Survived = titanic$Survived, yhat = yhat)
  check<-check%>%
    group_by(Survived)%>%
    summarise(yhat_median = median(yhat),
              yhat_5th = quantile(yhat, 0.05),
              yhat_95th = quantile(yhat, 0.95))  
  return(check)
}

simple_roc <- function(labels, scores){
  labels <- labels[order(scores, decreasing=TRUE)]
  data.frame(TPR=cumsum(labels)/sum(labels), 
             FPR=cumsum(!labels)/sum(!labels), labels,
             probs=scores[order(scores, decreasing = TRUE)])
}


check1<-check_logit_results(m1)
check1

```

This isn't terrible. We're definitely picking up on something. But we can do better!

### A more elaborate model

```{r}
m2<-glm(Survived~
          Sex + Age,
        data = titanic)
m2_results<-tidy(m2)
m2_results$odds_ratio<-exp(m2_results$estimate)
m2_results

check2<-check_logit_results(m2)
```

Add Pclass

```{r}
m3<-glm(Survived~
          Pclass + Sex + Age,
        data = titanic)
m3_results<-tidy(m3)
m3_results$odds_ratio<-exp(m3_results$estimate)
m3_results

check3<-check_logit_results(m3)
```

Let's compare these three just to see where we're at

```{r}
### make a list of models
models<-list(m1, m2, m3)
names<-c("age", "+sex", "+class")
### make an empty list for our output
roc_out<-list()
### loop over each model, create roc curve for each
for(i in 1:length(models)){
  roc_out[[i]]<-simple_roc(titanic$Survived, 
                           predict(models[[i]],
                                   type = "response"))
  ### add a label for plotting
  roc_out[[i]]$model<-names[i]
}

roc_plot<-bind_rows(roc_out)

### plot it!
ggplot(roc_plot,
       aes(x = FPR, y = TPR, color = model)) + 
  geom_line() + 
  geom_abline()
```

OK - so it wan't just "women and children first". It was "women, children, and the rich first"!

### Let's keep trying!

```{r}
m4<-glm(Survived~
          Pclass + Sex + Age + (sibs>0) + (kids>0),
        data = titanic)
tidy(m4)
check_logit_results(m4)
```

### Let's go nuts with interactions.

Maybe the effect of sex, age, and class all depend on each other. For example, maybe rich kids did better than poor kids? Maybe girls did better than boys? Maybe the super rich among the first class passengers did better? 

```{r}
m5<-glm(Survived~
          Pclass * (Sex * Age) + kids + sibs,
        data = titanic)
tidy(m5)
```

### Compare m1, m2, m3, m4, m5

```{r}
### make a list of models
models<-list(m1, m2, m3, m4, m5)
names<-c("age", "+sex", "+class", "+kids/sibs", "+interactions")
### make an empty list for our output
roc_out<-list()
### loop over each model, create roc curve for each
for(i in 1:length(models)){
  roc_out[[i]]<-simple_roc(titanic$Survived, 
                           predict(models[[i]],
                                   type = "response"))
  ### add a label for plotting
  roc_out[[i]]$model<-names[i]
}

roc_plot<-bind_rows(roc_out)

### plot it!
ggplot(roc_plot,
       aes(x = FPR, y = TPR, color = model)) + 
  geom_line() + 
  geom_abline()
```

We're not gettinghuge performance increases, but looks like the +interactions model is doing best by a hair. Let's proceed with that one.

### Checking some counterfactuals

Let's see the chances of survival for some counterfactual cases. We'll set sibs and kids equal to 1 for all cases.

- Case 1: 5 year old boy, 1st class
- Case 2: 5 year old girl, 1st class
- Case 3: 5 year old boy, 3rd class
- Case 4: 5 year old girl, 3rd class
- Case 5: 40 year old man, 1st class
- Case 6: 40 year old woman, 1st class
- Case 7: 40 year old man, 3rd class
- Case 8: 40 year old woman, 3rd class

```{r}
### make out counterfactual dataframe
cf_cases<-data.frame(
  Pclass = c("1", "1", "3", "3", "1", "1", "3", "3"),
  Sex = rep(c("male", "female"), 
            4),
  Age = c(rep(5, 4), rep(40, 4)),
  sibs = rep(1,8),
  kids = rep(1,8)
  )

cf_cases
```

Now predict the probabilities of survival for these unfortunate souls we've just conjured.

```{r}
yhat<-predict(m5, newdata = cf_cases, type = "response")
cf_cases<-bind_cols(yhat = yhat, cf_cases)
```

Plot it to compare

```{r}
ggplot(cf_cases,
       aes(y = yhat, shape = as.character(Age), x = Pclass, color = Sex)) + 
  geom_jitter(width = 0.05)
```

OK - rich women were most likely to survive, rich girls next, then rich boys, then poor girls, then poor women, then rich men, then poor boys. Poor men basically all died...